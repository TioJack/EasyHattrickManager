<main class="flex-grow-1 d-flex flex-column justify-content-center align-items-center text-center">
  <div *ngIf="viewMode === 'players'; else plannerView">
    <div class="row g-3 p-3 align-items-stretch">
      <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 col-xxl-4 d-flex">
        <app-player-stats class="flex-fill w-100"></app-player-stats>
      </div>
      <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 col-xxl-4 d-flex">
        <app-staff class="flex-fill w-100"></app-staff>
      </div>
      <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6 col-xxl-4 d-flex">
        <app-training class="flex-fill w-100"></app-training>
      </div>
      <div *ngFor="let player of basePlayers; trackBy: trackByPlayerId" class="col-sm-12 col-md-12 col-lg-6 col-xl-6 col-xxl-4 d-flex">
        <app-player-card class="flex-fill w-100" [player]="player" [training]="training"></app-player-card>
      </div>
    </div>
  </div>

  <ng-template #plannerView>
    <div class="planner-overlay-root" [attr.aria-busy]="isTeamTrainingLoading">
      <fieldset class="planner-busy-fieldset">
        <div class="row g-3 p-3 w-100 align-items-stretch">
      <div class="col-12">
        <div class="planner-row align-items-stretch">
          <div class="planner-side">
            <div class="d-flex flex-column gap-2">
              <div class="card w-100">
                <div class="py-2">
                  <div class="card-body p-2">
                  <div class="d-flex flex-column gap-2">
                    <div class="d-flex align-items-center gap-2 flex-nowrap">
                      <span class="text-muted small text-nowrap flex-shrink-0">
                        {{ 'ehm.training' | translate | firstCapitalize }}
                      </span>
                      <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="newTrainingTypeId">
                        <option *ngFor="let typeId of trainingTypes" [ngValue]="typeId">
                          {{ ('ht.training-type-' + typeId) | translate | firstCapitalize }}
                        </option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-nowrap">
                      <span class="text-muted small flex-shrink-0 d-flex flex-column">
                        <span class="text-nowrap">{{ 'ehm.duration' | translate | firstCapitalize }}</span>
                        <span class="text-nowrap">({{ 'ehm.weeks' | translate }})</span>
                      </span>
                      <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="newTrainingWeeks">
                        <option *ngFor="let weeks of durationOptions" [ngValue]="weeks">
                          {{ getDurationLabel(weeks) }}
                        </option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-nowrap">
                      <span class="text-muted small flex-shrink-0 d-flex flex-column">
                        <span class="text-nowrap">{{ 'ehm.coach' | translate | firstCapitalize }}</span>
                      </span>
                      <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="newTrainingCoach">
                        <option *ngFor="let level of trainerLevelOptions" [ngValue]="level">
                          {{ level }} - {{ getTrainerLevelTranslationKey(level) | translate | firstCapitalize }}
                        </option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-nowrap">
                      <span class="text-muted small flex-shrink-0 d-flex flex-column">
                        <span class="text-nowrap">{{ 'ehm.assistant-coach' | translate | firstCapitalize }}</span>
                      </span>
                      <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="newTrainingAssistants">
                        <option *ngFor="let assistants of assistantOptions" [ngValue]="assistants">
                          {{ assistants }}
                        </option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-nowrap">
                      <span class="text-muted small flex-shrink-0 d-flex flex-column">
                        <span class="text-nowrap">{{ 'ehm.intensity' | translate | firstCapitalize }}</span>
                      </span>
                      <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="newTrainingIntensity">
                        <option *ngFor="let intensity of intensityOptions" [ngValue]="intensity">
                          {{ intensity }}
                        </option>
                      </select>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-nowrap">
                      <span class="text-muted small flex-shrink-0 d-flex flex-column">
                        <span class="text-nowrap">{{ 'ehm.stamina' | translate | firstCapitalize }}</span>
                      </span>
                      <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="newTrainingStamina">
                        <option *ngFor="let stamina of staminaOptions" [ngValue]="stamina">
                          {{ stamina }}
                        </option>
                      </select>
                    </div>
                    <button class="btn btn-sm btn-primary" type="button" (click)="addTrainingPlan()">
                      {{ 'ehm.add-training-stage' | translate | firstCapitalize }}
                    </button>
                  </div>
                </div>
                </div>
              </div>

            </div>
          </div>
          <div class="planner-center d-flex">
            <div class="card flex-fill w-100">
              <div class="card-body p-2" [class.planner-empty]="trainingPlans.length === 0">
                <div *ngIf="trainingPlans.length === 0" class="planner-empty-message text-center fw-semibold p-3 border rounded bg-light">
                  <div>{{ 'ehm.training-planner-welcome' | translate }}</div>
                  <div>{{ 'ehm.training-planner-help' | translate }}</div>
                  <div class="mt-0 fs-1 planner-empty-arrow">‚Üê</div>
                </div>
                <div *ngIf="trainingPlans.length > 0" class="planner-stack">
                  <div
                    *ngFor="let plan of trainingPlans; let i = index; trackBy: trackByStageIndex"
                    class="planner-segment planner-segment--form"
                    [style.flex-grow]="plan.weeks"
                    [style.flex-basis.%]="0"
                    [style.backgroundColor]="trainingTypeColor(plan.typeId)"
                    [style.color]="getTrainingTextColor(plan.typeId)">
                    <div class="d-flex flex-column gap-2 w-100">
                      <div class="d-flex align-items-center gap-2 flex-nowrap">
                        <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="plan.typeId" (ngModelChange)="onStageTypeChanged(i)">
                          <option *ngFor="let typeId of trainingTypes" [ngValue]="typeId">
                            {{ ('ht.training-type-' + typeId) | translate | firstCapitalize }}
                          </option>
                        </select>
                      </div>
                      <div class="d-flex align-items-center gap-2 flex-nowrap">
                        <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="plan.weeks" (ngModelChange)="onStageUpdated()">
                          <option *ngFor="let weeks of durationOptions" [ngValue]="weeks">
                            {{ getDurationLabel(weeks) }}
                          </option>
                        </select>
                      </div>
                      <div class="d-flex align-items-center gap-2 flex-nowrap">
                        <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="plan.coach" (ngModelChange)="onStageUpdated()">
                          <option *ngFor="let level of trainerLevelOptions" [ngValue]="level">
                            {{ level }} - {{ getTrainerLevelTranslationKey(level) | translate | firstCapitalize }}
                          </option>
                        </select>
                      </div>
                      <div class="d-flex align-items-center gap-2 flex-nowrap">
                        <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="plan.assistants" (ngModelChange)="onStageUpdated()">
                          <option *ngFor="let assistants of assistantOptions" [ngValue]="assistants">
                            {{ assistants }}
                          </option>
                        </select>
                      </div>
                      <div class="d-flex align-items-center gap-2 flex-nowrap">
                        <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="plan.intensity" (ngModelChange)="onStageLoadUpdated()">
                          <option *ngFor="let intensity of intensityOptions" [ngValue]="intensity">
                            {{ intensity }}
                          </option>
                        </select>
                      </div>
                      <div class="d-flex align-items-center gap-2 flex-nowrap">
                        <select class="form-select form-select-sm flex-grow-1" [(ngModel)]="plan.stamina" (ngModelChange)="onStageLoadUpdated()">
                          <option *ngFor="let stamina of staminaOptions" [ngValue]="stamina">
                            {{ stamina }}
                          </option>
                        </select>
                      </div>
                      <div class="planner-stage-actions">
                        <button class="btn btn-sm planner-stage-move planner-stage-move--white" type="button" (click)="moveTrainingPlan(i, -1)" [disabled]="i === 0" aria-label="Mover a la izquierda">
                          <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="btn btn-sm btn-danger planner-stage-delete" type="button" (click)="removeTrainingPlan(i)" aria-label="Eliminar">
                          <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm planner-stage-move planner-stage-move--white" type="button" (click)="moveTrainingPlan(i, 1)" [disabled]="i === trainingPlans.length - 1" aria-label="Mover a la derecha">
                          <i class="bi bi-chevron-right"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="planner-side d-flex">
            <div class="card w-100 h-100">
              <div class="card-body p-3">
                <div *ngIf="endWeekInfo; else noEndWeek" class="planner-summary">
                  <div class="planner-summary-header">
                    <div class="fw-bold">
                      {{ 'ehm.season' | translate }} {{ endWeekInfo.season }}
                      {{ 'ehm.week' | translate }} {{ endWeekInfo.week }}
                    </div>
                    <div class="text-muted small">
                      {{ endWeekInfo.date | date:DEFAULT_DATE_FORMAT }}
                    </div>
                  </div>
                  <div class="planner-summary-divider"></div>
                  <div>
                    <div class="planner-ratings-title planner-ratings-title--center">
                      {{ 'ehm.statistics-totals' | translate | firstCapitalize }}
                    </div>
                    <div class="planner-stats-list planner-summary-stats-list">
                      <div class="planner-stats-row planner-stats-row--summary">
                        <span class="planner-stats-label">{{ 'ehm.wage' | translate | firstCapitalize }}</span>
                        <span class="planner-stats-value">
                          {{ userConfig ? (getTotalWagesPaid() | salary:userConfig.currency) : (getTotalWagesPaid() | numberSeparator) }}
                        </span>
                      </div>
                      <div class="planner-stats-row">
                        <span class="planner-stats-label">{{ 'ehm.weeks' | translate | firstCapitalize }}</span>
                        <span class="planner-stats-value">{{ getTotalTrainingWeeks() }}</span>
                      </div>
                      <div class="planner-stats-row">
                        <span class="planner-stats-label">{{ 'ehm.seasons' | translate | firstCapitalize }}</span>
                        <span class="planner-stats-value">{{ getTotalTrainingSeasons() }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <ng-template #noEndWeek></ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <button
          type="button"
          class="planner-toggle"
          [class.planner-toggle--inactive]="!showPlannerPlayers"
          (click)="togglePlannerPlayers()"
          [attr.aria-expanded]="showPlannerPlayers">
          <span class="planner-toggle__icon">
            <i class="bi" [class.bi-chevron-down]="showPlannerPlayers" [class.bi-chevron-up]="!showPlannerPlayers"></i>
          </span>
          <span class="planner-toggle__label">
            {{ 'ehm.players' | translate | lowercase }}
          </span>
        </button>
      </div>

      <ng-container *ngIf="showPlannerPlayers">
        <div *ngFor="let player of players; trackBy: trackByPlayerId" class="col-12">
          <div class="planner-row align-items-stretch">
            <div class="planner-side d-flex">
              <app-player-card-compact class="flex-fill w-100" [player]="player"></app-player-card-compact>
            </div>
            <div class="planner-center d-flex">
              <div class="card flex-fill w-100">
                <div class="card-body p-2 d-flex flex-column planner-center-body">
                  <div *ngIf="trainingPlans.length === 0" class="text-muted"></div>
                  <div *ngIf="trainingPlans.length > 0" class="planner-sliders-area">
                    <div class="planner-sliders">
                      <div
                        *ngFor="let plan of trainingPlans; let i = index; trackBy: trackByStageIndex"
                        class="planner-slider-segment"
                        [style.flex-grow]="plan.weeks"
                        [style.flex-basis.%]="0">
                        <input
                          class="planner-slider"
                          type="range"
                          orient="vertical"
                          min="0"
                          max="100"
                          [style.accentColor]="trainingTypeColor(plan.typeId)"
                          [ngModel]="getPlanPercent(player.id, i)"
                          (ngModelChange)="setPlanPercent(player.id, i, $event)"
                          (change)="onPlanPercentCommit()">
                        <div class="planner-slider-value text-nowrap">
                          {{ getPlanPercent(player.id, i) }}%
                        </div>
                      </div>
                    </div>
                  </div>
                  <div *ngIf="trainingPlans.length > 0" class="planner-timeline-area">
                    <div
                      class="planner-timeline"
                      (mousemove)="onTimelineMove($event, player.id)"
                      (mouseleave)="onTimelineLeave(player.id)">
                      <div class="planner-timeline-bar">
                        <div
                          *ngFor="let range of getMaxHtmsRanges(player.id)"
                          class="planner-timeline-marker"
                          [class.planner-timeline-marker--range]="range.widthPercent > 0"
                          [style.left.%]="range.leftPercent"
                          [style.width.%]="range.widthPercent">
                        </div>
                        <div
                          *ngFor="let plan of trainingPlans; trackBy: trackByStageIndex"
                          class="planner-timeline-segment"
                          [style.flex-grow]="plan.weeks"
                          [style.flex-basis.%]="0"
                          [style.backgroundColor]="trainingTypeColor(plan.typeId)"
                          [style.color]="getTrainingTextColor(plan.typeId)">
                          <span class="planner-timeline-segment-label">
                            {{ ('ht.training-type-' + plan.typeId) | translate | firstCapitalize }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div
                    *ngIf="getTimelinePopupPlayer(player.id) as timelinePlayer"
                    class="planner-timeline-popup"
                    [class.planner-timeline-popup--prime]="isPrimeWeek(player.id)"
                    [style.left.%]="getTimelinePercent(player.id)">
                    <app-player-card-compact [player]="timelinePlayer"></app-player-card-compact>
                  </div>
                </div>
              </div>
            </div>
            <div class="planner-side d-flex">
              <ng-container *ngIf="getPlannerResultPlayer(player.id) as result; else noResult">
                <app-player-card-compact class="flex-fill w-100" [player]="result"></app-player-card-compact>
              </ng-container>
              <ng-template #noResult>
                <div class="card flex-fill w-100"></div>
              </ng-template>
            </div>
          </div>
        </div>
      </ng-container>

      <div *ngIf="players.length > 0" class="col-12">
        <button
          type="button"
          class="planner-toggle"
          [class.planner-toggle--inactive]="!showPlannerRatings"
          (click)="togglePlannerRatings()"
          [attr.aria-expanded]="showPlannerRatings">
          <span class="planner-toggle__icon">
            <i class="bi" [class.bi-chevron-down]="showPlannerRatings" [class.bi-chevron-up]="!showPlannerRatings"></i>
          </span>
          <span class="planner-toggle__label">
            {{ 'ehm.lineup-ratings' | translate }}
          </span>
        </button>
      </div>

      <div *ngIf="players.length > 0 && showPlannerRatings" class="col-12">
        <div class="planner-ratings-layout">
          <div class="planner-ratings-form-card card">
            <div class="card-body">
              <div class="planner-ratings-form">
                <div class="planner-ratings-fields mb-3">
                  <div class="planner-field d-flex flex-row align-items-center gap-2">
                    <button
                      class="btn btn-sm btn-primary w-100"
                      type="button"
                      (click)="calculateBestFormationOnDemand()"
                      [disabled]="isTeamTrainingLoading || trainingPlans.length === 0">
                      {{ 'ehm.calculate-best-lineup' | translate | firstCapitalize }}
                    </button>
                  </div>
                  <div class="planner-field d-flex flex-row align-items-center gap-2">
                    <span class="planner-field-label mb-0 d-inline-flex align-items-center gap-1">
                      <i class="bi bi-arrow-repeat" aria-hidden="true"></i>
                      <span>{{ 'ehm.auto-refresh' | translate | firstCapitalize }}</span>
                    </span>
                    <input
                      class="form-check-input m-0"
                      type="checkbox"
                      [(ngModel)]="autoRefreshBestFormation"
                      (ngModelChange)="onAutoRefreshBestFormationChanged()">
                  </div>
                </div>
                <div class="planner-ratings-title">
                  {{ 'ehm.lineup-parameters' | translate | firstCapitalize }}
                </div>
                <div class="planner-ratings-fields">
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ehm.best-lineup-criteria' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="bestFormationCriteria" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let criteria of bestFormationCriteriaOptions" [ngValue]="criteria">
                        {{ getCriteriaLabel(criteria) }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ehm.formation' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="fixedFormationCode" (ngModelChange)="onRatingsInputChanged()">
                      <option [ngValue]="null">{{ 'ehm.automatic' | translate | firstCapitalize }}</option>
                      <option *ngFor="let option of fixedFormationOptions" [ngValue]="option.code">
                        {{ getFixedFormationOptionLabel(option) }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ht.tactic-types' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="matchDetail.tactic" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let tactic of tacticOptions" [ngValue]="tactic">
                        {{ getTacticTranslationKey(tactic) | translate | firstCapitalize }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ht.team-attitude' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="matchDetail.teamAttitude" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let attitude of teamAttitudeOptions" [ngValue]="attitude">
                        {{ getTeamAttitudeTranslationKey(attitude) | translate | firstCapitalize }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ht.team-spirit' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="matchDetail.teamSpirit" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let spirit of teamSpiritOptions" [ngValue]="spirit">
                        {{ getTeamSpiritTranslationKey(spirit) | translate | firstCapitalize }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ehm.team-spirit-sublevel' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="matchDetail.teamSubSpirit" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let value of subSpiritOptions" [ngValue]="value">
                        {{ value }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ehm.team-confidence' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="matchDetail.teamConfidence" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let confidence of teamConfidenceOptions" [ngValue]="confidence">
                        {{ getTeamConfidenceTranslationKey(confidence) | translate | firstCapitalize }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ehm.team-confidence-sublevel' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="matchDetail.teamSubConfidence" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let value of subSpiritOptions" [ngValue]="value">
                        {{ value }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ehm.stadium' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="matchDetail.sideMatch" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let side of sideMatchOptions" [ngValue]="side">
                        {{ getSideMatchLabel(side) }}
                      </option>
                    </select>
                  </label>
                  <label class="planner-field">
                    <span class="planner-field-label">{{ 'ehm.style-of-play' | translate | firstCapitalize }}</span>
                    <select class="form-select form-select-sm" [(ngModel)]="matchDetail.styleOfPlay" (ngModelChange)="onRatingsInputChanged()">
                      <option *ngFor="let value of styleOfPlayOptions" [ngValue]="value">
                        {{ getStyleOfPlayLabel(value) }}
                      </option>
                    </select>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="planner-ratings card" [class.planner-ratings--prime-hover]="isBestFormationPrimeHover()">
            <div class="card-body p-2 d-flex flex-column">
            <div *ngIf="trainingPlans.length > 0" class="planner-formation-chart-area">
              <div class="planner-hatstats-header">
                <span class="planner-hatstats-title">{{ 'ehm.evolution' | translate | firstCapitalize }}</span>
                <span class="planner-hatstats-week">{{ getDisplayedFormationWeekText() }}</span>
                <span class="planner-hatstats-best-week">{{ getBestFormationWeekText() }}</span>
              </div>
              <div
                class="planner-hatstats-chart"
                (mousemove)="onBestFormationTimelineMove($event)"
                (mouseleave)="onBestFormationTimelineLeave()">
                <div class="planner-hatstats-chart__segments">
                  <div
                    *ngFor="let plan of trainingPlans; trackBy: trackByStageIndex"
                    class="planner-hatstats-chart__segment"
                    [style.flex-grow]="plan.weeks"
                    [style.flex-basis.%]="0"
                    [style.backgroundColor]="trainingTypeColor(plan.typeId)">
                  </div>
                </div>
                <div
                  *ngFor="let range of getBestFormationPrimeRanges()"
                  class="planner-hatstats-chart__prime-range"
                  [style.left.%]="range.leftPercent"
                  [style.width.%]="range.widthPercent">
                </div>
                <svg class="planner-hatstats-chart__svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                  <path class="planner-hatstats-chart__line" [attr.d]="getBestFormationHatStatsPath()"></path>
                </svg>
                <div
                  *ngFor="let point of getBestFormationHatStatsPoints()"
                  class="planner-hatstats-chart__point-dot"
                  [class.planner-hatstats-chart__point-dot--prime]="point.isPrime"
                  [class.planner-hatstats-chart__point-dot--hover]="point.isHover"
                  [style.left.%]="point.xPercent"
                  [style.top.%]="point.yPercent"
                  [attr.title]="'W' + point.week + ': ' + (point.value | number:'1.0-2')">
                </div>
                <div
                  *ngIf="bestFormationTimelineHoverPercent != null"
                  class="planner-hatstats-chart__hover-marker"
                  [style.left.%]="bestFormationTimelineHoverPercent">
                </div>
              </div>
            </div>
            <div *ngIf="trainingPlans.length > 0" class="planner-formation-timeline-area">
              <div
                class="planner-timeline planner-timeline--summary"
                (mousemove)="onBestFormationTimelineMove($event)"
                (mouseleave)="onBestFormationTimelineLeave()">
                <div class="planner-timeline-bar">
                  <div
                    *ngIf="bestFormationTimelineHoverPercent != null"
                    class="planner-timeline-marker planner-timeline-marker--hover"
                    [style.left.%]="bestFormationTimelineHoverPercent">
                  </div>
                  <div
                    *ngFor="let range of getBestFormationPrimeRanges()"
                    class="planner-timeline-marker planner-timeline-marker--range"
                    [style.left.%]="range.leftPercent"
                    [style.width.%]="range.widthPercent">
                  </div>
                  <div
                    *ngFor="let plan of trainingPlans; trackBy: trackByStageIndex"
                    class="planner-timeline-segment"
                    [style.flex-grow]="plan.weeks"
                    [style.flex-basis.%]="0"
                    [style.backgroundColor]="trainingTypeColor(plan.typeId)"
                    [style.color]="getTrainingTextColor(plan.typeId)">
                    <span class="planner-timeline-segment-label">
                      {{ ('ht.training-type-' + plan.typeId) | translate | firstCapitalize }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <div class="planner-ratings-pitches">
                <div class="planner-pitch-panel">
                  <div class="planner-pitch-title">
                    {{ 'ehm.best-lineup' | translate | firstCapitalize }}: {{ getBestFormationSummary() }}
                  </div>
                  <div class="lineup-field">
                    <svg class="lineup-overlay" viewBox="0 0 650 340" preserveAspectRatio="none">
                      <ng-container *ngFor="let trap of lineupTraps">
                        <polygon [attr.points]="getLineupTrapPoints(trap)" class="lineup-trap"></polygon>
                      </ng-container>
                      <ng-container *ngFor="let marker of getLineupDirectionMarkers()">
                        <polygon [attr.points]="marker.band" class="lineup-direction-band"></polygon>
                        <polygon [attr.points]="marker.triangle" class="lineup-direction-triangle"></polygon>
                      </ng-container>
                    </svg>
                    <div
                      *ngFor="let item of getBestFormationPlayers()"
                      class="lineup-position"
                      [style.left.%]="item.left"
                      [style.top.%]="item.top"
                      [title]="item.tooltip">
                      <div class="lineup-player-name">{{ item.shortName }}</div>
                    </div>
                  </div>
                </div>

                <div class="planner-pitch-panel">
                  <div class="planner-pitch-title">
                    {{ 'ht.rating-sectors' | translate | firstCapitalize }}
                  </div>
                  <div class="planner-half-pitch planner-half-pitch--zones">
                    <div class="planner-zones-grid">
                      <svg class="planner-zones-overlay" viewBox="0 0 650 340" preserveAspectRatio="none">
                        <ng-container *ngFor="let zoneTrap of ratingZoneTraps">
                          <polygon [attr.points]="getRatingZoneTrapPoints(zoneTrap)" class="planner-zone-trap"></polygon>
                        </ng-container>
                      </svg>
                      <ng-container *ngFor="let zoneTrap of ratingZoneTraps">
                        <div
                          class="planner-zone-node"
                          [style.left.%]="getRatingZoneTrapCenter(zoneTrap).left"
                          [style.top.%]="getRatingZoneTrapCenter(zoneTrap).top"
                          [attr.title]="(zoneTrap.labelKey | translate | firstCapitalize)"
                          [attr.aria-label]="(zoneTrap.labelKey | translate | firstCapitalize)">
                          <span class="planner-zone-value">
                            {{
                              getBestFormationZoneValue(zoneTrap.zoneId) != null
                                ? (getBestFormationZoneValue(zoneTrap.zoneId) | number:'1.0-2')
                                : '-'
                            }}
                          </span>
                        </div>
                      </ng-container>
                    </div>
                  </div>
                </div>
            </div>
            </div>
          </div>

          <div class="planner-ratings-stats card">
            <div class="card-body">
              <div class="planner-summary-header planner-ratings-summary-header">
                <div class="fw-bold">{{ getDisplayedFormationSeasonWeekText() }}</div>
                <div class="text-muted small">
                  {{ getDisplayedFormationDate() | date:DEFAULT_DATE_FORMAT }}
                </div>
              </div>
              <div class="planner-summary-divider planner-ratings-summary-divider"></div>
              <div class="planner-ratings-title planner-ratings-title--center">{{ 'ehm.statistics-weekly' | translate | firstCapitalize }}</div>
              <div class="planner-stats-list">
                <div class="planner-stats-row planner-stats-row--summary">
                  <span class="planner-stats-label">{{ 'ehm.wage' | translate | firstCapitalize }}</span>
                  <span class="planner-stats-value">
                    {{
                      getDisplayedWeekSalary() != null
                        ? (userConfig
                          ? (getDisplayedWeekSalary()! | salary:userConfig.currency)
                          : (getDisplayedWeekSalary()! | numberSeparator))
                        : '-'
                    }}
                  </span>
                </div>
                <div
                  class="planner-stats-row"
                  [class.planner-stats-row--active]="stat.criteria === bestFormationCriteria"
                  *ngFor="let stat of getBestFormationRelevantStats()">
                  <span class="planner-stats-label">{{ stat.label }}</span>
                  <span class="planner-stats-value">
                    {{ stat.value != null ? (stat.value | number:'1.0-2') : '-' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

          <div *ngIf="players.length === 0" class="col-12 text-muted">
            {{ 'ehm.no-players' | translate | firstCapitalize }}
          </div>
        </div>
      </fieldset>

      <div *ngIf="isTeamTrainingLoading" class="planner-loading-overlay" role="status" aria-live="polite" [attr.aria-label]="'ehm.calculating-training-plan' | translate">
        <div class="planner-loading-box">
          <div class="spinner-border text-warning" role="presentation" aria-hidden="true"></div>
          <div class="planner-loading-content">
            <div class="planner-loading-text">{{ 'ehm.calculating-training-plan' | translate }}</div>
            <div class="planner-loading-progress-text">
              {{ teamTrainingProgressCalculatedWeeks }} / {{ teamTrainingProgressTotalWeeks }} {{ 'ehm.weeks' | translate }} ({{ teamTrainingProgressPercent }}%)
            </div>
            <div class="planner-loading-progress-track" aria-hidden="true">
              <div class="planner-loading-progress-value" [style.width.%]="teamTrainingProgressPercent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
</main>
